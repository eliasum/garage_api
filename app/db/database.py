"""
НАСТРОЙКА ПОДКЛЮЧЕНИЯ К БАЗЕ ДАННЫХ

Назначение: Этот файл настраивает подключение к базе данных и управление сессиями.
Содержит всё необходимое для работы SQLAlchemy с БД и интеграции с FastAPI.

Основные компоненты:
1. Engine (движок) - низкоуровневое подключение к БД
2. SessionLocal - фабрика для создания сессий работы с БД
3. get_db() - зависимость для FastAPI (жизненный цикл сессии на запрос)
"""

from typing import Iterator

from sqlalchemy import create_engine
from sqlalchemy.orm import Session, sessionmaker

# URL подключения к базе данных SQLite.
# Формат: sqlite:///<относительный_путь_к_файлу>
# Три слеша (///) означают относительный путь от корня проекта.
SQLALCHEMY_DATABASE_URL = "sqlite:///./garage.db"
# Файл garage.db появится в корне проекта при первом обращении к БД.

# 1. СОЗДАНИЕ ДВИЖКА (ENGINE)
# Движок = фасад для работы с БД, управляет пулом соединений.
engine = create_engine(
    SQLALCHEMY_DATABASE_URL,
    connect_args={
        "check_same_thread": False
        # ↑ КРИТИЧЕСКИ ВАЖНО для SQLite + FastAPI!
        # Разрешает использовать одно соединение из разных потоков.
        # Без этого FastAPI будет падать с ошибками при параллельных запросах.
    },
)
# check_same_thread=False — это временное решение для разработки. Для продакшена с
# SQLite нужно будет использовать более сложную конфигурацию или перейти на PostgreSQL.

# 2. ФАБРИКА СЕССИЙ (SESSION FACTORY)
# Сессия = единица работы с БД (аналог транзакции, но более высокоуровневый).
# SessionLocal - это фабрика, которая будет создавать новые сессии.
SessionLocal = sessionmaker(
    autocommit=False,  # Мы сами управляем коммитами через db.commit()
    autoflush=False,  # Мы сами управляем сбросом изменений в БД
    bind=engine,  # Привязываем фабрику к нашему движку
)

# Жизненный цикл сессии в FastAPI:
# Запрос → get_db() создаёт сессию → Роутер работает с БД → Сессия закрывается


# 3. ЗАВИСИМОСТЬ ДЛЯ FASTAPI (DEPENDENCY)
# FastAPI будет вызывать эту функцию при каждом запросе к API.
# yield обеспечивает: "открыть сессию -> отдать в обработчик -> закрыть сессию".
def get_db() -> Iterator[Session]:
    """
    Генератор сессий БД для FastAPI.

    Использование в роутерах:
    @app.get("/items")
    def read_items(db: Session = Depends(get_db)):
        # Здесь db - активная сессия БД
        items = db.query(Item).all()
        return items

    Принцип работы:
    1. При запросе FastAPI вызывает get_db()
    2. Создаётся новая сессия (db = SessionLocal())
    3. Сессия передаётся в роутер через yield
    4. После обработки запроса выполняется finally
    5. Сессия гарантированно закрывается (db.close())
    """
    db = SessionLocal()
    try:
        yield db  # Отдаём сессию в роутер для обработки запроса
    finally:
        db.close()  # Всегда закрываем сессию, даже если в роутере была ошибка

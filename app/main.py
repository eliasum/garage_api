# 2025.11.27 18:43 IMM

# ГЛАВНЫЙ ВХОД, ОБЩИЕ ЭНДПОИНТЫ

# Импорты
from typing import Any, Dict

from app.api.parts import router as parts_router  # Импортируем "магазин запчастей"
from app.database import garage, init_test_data  # Импортируем из database.py
from fastapi import FastAPI

# 1. СОЗДАНИЕ ПРИЛОЖЕНИЯ FASTAPI
# FastAPI() — конструктор, создаёт веб-приложение
# title, description — метаданные для документации

# FastAPI (реактивный, событийно-ориентированный)
# Что это: Приложение, которое ждет запросов и реагирует на них.
# Аналог из жизни: Работа курьерского сервиса. Ты ждешь заказов, и когда приходит заказ, выполняешь его.

# СОЗДАЕМ FASTAPI ПРИЛОЖЕНИЕ
app = FastAPI(title="Garage API", description="API для учета запчастей в гараже")


# ✅ ИНИЦИАЛИЗИРУЕМ ТЕСТОВЫЕ ДАННЫЕ
init_test_data()  # Вызываем функцию из database.py


# 6. ПОДКЛЮЧЕНИЕ РОУТЕРА К ПРИЛОЖЕНИЮ
# Без этой строки роутер не будет работать!
app.include_router(parts_router)


# 7. КОРНЕВОЙ ЭНДПОИНТ (GET /)
# Возвращает информацию об API
@app.get("/")
def read_root() -> Dict[str, Any]:  # для формирования документации
    """Основная страница API с информацией о доступных эндпоинтах"""
    return {
        "message": "Garage API работает!",
        "endpoints": {
            "parts_list": "/parts",
            "health_check": "/health",
            "docs": "/docs",
        },
    }


# 8. ЭНДПОИНТ ПРОВЕРКИ ЗДОРОВЬЯ (GET /health)
# Используется для мониторинга
@app.get("/health")
def health_check() -> Dict[str, Any]:  # для формирования документации
    """Проверка состояния сервиса (используется системами мониторинга)"""
    return {
        "status": "OK",
        "total_parts": len(garage.list_parts()),  # Считаем запчасти
        "service": "garage-api",
        "version": "0.1.0",
    }


# 11. ЗАПУСК СЕРВЕРА (если файл запущен напрямую)
# Как работает: Запускается веб-сервер (uvicorn), который начинает "слушать" порт 8000
# Время жизни: Сервер работает бесконечно (пока его не остановят), ожидая HTTP-запросы
# Пример из жизни: Открыл магазин и ждешь клиентов 24/7

if __name__ == "__main__":
    import uvicorn

    uvicorn.run(app, host="0.0.0.0", port=8000)

# __name__ - это специальная переменная Python
# Когда файл запускают напрямую (python app/main.py), то __name__ == "__main__"
# Когда файл импортируют из другого модуля, то __name__ == "app.main"
# То есть код внутри if __name__ == "__main__": выполняется только при прямом запуске файла.

# FastAPI = "Конструктор веб-API". Он берёт на себя:
#     HTTP протокол
#     JSON парсинг
#     Документацию (Swagger)
#     Валидацию данных
#     Обработку ошибок
#     Многопоточность
